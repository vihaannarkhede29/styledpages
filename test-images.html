<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Automatic Image Placement</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 800px;
            margin: 0 auto;
        }
        .test-content {
            border: 1px solid #ddd;
            padding: 20px;
            margin: 20px 0;
            background: #fafafa;
            min-height: 400px;
        }
        .pdf-preview {
            font-family: var(--body-font, 'Inter', sans-serif);
            line-height: var(--line-spacing, 1.5);
            color: var(--body-color, #1e293b);
            font-size: var(--body-size, 14px);
            padding: var(--margin-top, 1in) var(--margin-right, 1in) var(--margin-bottom, 1in) var(--margin-left, 1in) !important;
            position: relative;
            background: white;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            min-height: var(--page-height, 11in);
            width: var(--page-width, 8.5in);
            page-break-after: always;
            border: 1px solid #e5e7eb;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }
        .pdf-preview h1 {
            font-family: var(--title-font, 'Inter', sans-serif);
            color: var(--title-color, #1e40af);
            font-size: var(--title-size, 32px);
            font-weight: 700;
            margin: 0 0 1.5rem 0;
            padding: 0 0 0.5rem 0;
            border-bottom: 3px solid var(--accent-color, #3b82f6);
            line-height: 1.2;
            text-align: var(--title-alignment, var(--text-alignment, left));
        }
        .pdf-preview h2 {
            font-family: var(--header-font, 'Inter', sans-serif);
            color: var(--header-color, #3b82f6);
            font-size: var(--header-size, 24px);
            font-weight: 600;
            margin: 2rem 0 1rem 0;
            padding: 0;
            line-height: 1.3;
            text-align: var(--header-alignment, var(--text-alignment, left));
        }
        .pdf-preview p {
            font-family: var(--body-font, 'Inter', sans-serif);
            color: var(--body-color, #475569);
            font-size: var(--body-size, 14px);
            line-height: var(--line-spacing, 1.5);
            margin: 0 0 1rem 0;
            padding: 0;
            text-align: var(--body-alignment, var(--text-alignment, left));
        }
        .auto-placed-image {
            margin: 20px 0;
            text-align: center;
        }
        .auto-placed-image img {
            width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .image-caption {
            font-size: 12px;
            color: #6b7280;
            text-align: center;
            margin-top: 8px;
            font-style: italic;
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .test-button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>Test Automatic Image Placement</h1>
        
        <div class="test-content">
            <div id="pdfPreview" class="pdf-preview">
                <h1>Business Strategy Document</h1>
                <p>This is a test document to see if automatic image placement works. The system should detect empty space and add relevant images automatically.</p>
                
                <h2>Market Analysis</h2>
                <p>Our comprehensive market analysis reveals significant opportunities in the technology sector. The data shows strong growth potential across multiple verticals.</p>
                
                <h2>Financial Projections</h2>
                <p>Based on our research, we project substantial revenue growth over the next three years. The numbers are promising and align with industry trends.</p>
                
                <h2>Implementation Plan</h2>
                <p>We will implement this strategy in phases, starting with the most critical components. Each phase builds upon the previous one to ensure success.</p>
            </div>
        </div>
        
        <button class="test-button" onclick="testImagePlacement()">Test Image Placement</button>
        <button class="test-button" onclick="clearImages()">Clear Images</button>
        <button class="test-button" onclick="addMoreContent()">Add More Content</button>
        
        <div id="status"></div>
    </div>

    <script>
        // Simulate the ImageManager functionality
        class TestImageManager {
            constructor() {
                this.pexelsApiKey = '01dD2keJqF7zBQJBZosCJUXvjtMtc56YLcqi0OSnYipTQW9IbitELxAN';
                this.baseUrl = 'https://api.pexels.com/v1';
                this.imageCache = new Map();
                this.autoImageEnabled = true;
                this.minEmptySpace = 100;
                this.maxImagesPerPage = 3;
                this.currentImages = new Set();
            }

            async searchImages(query, perPage = 5) {
                try {
                    const cacheKey = `search_${query}_${perPage}`;
                    if (this.imageCache.has(cacheKey)) {
                        return this.imageCache.get(cacheKey);
                    }

                    const response = await fetch(`${this.baseUrl}/search?query=${encodeURIComponent(query)}&per_page=${perPage}`, {
                        headers: {
                            'Authorization': this.pexelsApiKey
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`Pexels API error: ${response.status}`);
                    }

                    const data = await response.json();
                    const images = data.photos.map(photo => ({
                        id: photo.id,
                        url: photo.src.medium,
                        alt: photo.alt,
                        photographer: photo.photographer,
                        photographerUrl: photo.photographer_url,
                        width: photo.width,
                        height: photo.height
                    }));

                    this.imageCache.set(cacheKey, images);
                    return images;
                } catch (error) {
                    console.error('Error fetching images from Pexels:', error);
                    return [];
                }
            }

            extractKeywords(content) {
                const text = content.toLowerCase();
                const keywords = [];
                
                const businessTerms = ['business', 'meeting', 'office', 'team', 'work', 'project', 'strategy', 'planning', 'analysis', 'report', 'presentation', 'data', 'chart', 'graph', 'technology', 'innovation', 'growth', 'success', 'leadership', 'management'];
                
                if (businessTerms.some(term => text.includes(term))) {
                    keywords.push('business', 'office', 'professional');
                }
                
                const words = text.split(/\s+/)
                    .filter(word => word.length > 4)
                    .filter(word => !['this', 'that', 'with', 'from', 'they', 'have', 'been', 'were', 'said', 'each', 'which', 'their', 'time', 'will', 'about', 'there', 'could', 'other', 'after', 'first', 'well', 'also', 'where', 'much', 'some', 'very', 'when', 'here', 'just', 'into', 'over', 'think', 'back', 'then', 'them', 'these', 'so', 'its', 'now', 'find', 'any', 'new', 'work', 'part', 'take', 'get', 'place', 'made', 'live', 'where', 'after', 'back', 'little', 'only', 'round', 'man', 'year', 'came', 'show', 'every', 'good', 'me', 'give', 'our', 'under', 'name', 'very', 'through', 'just', 'form', 'sentence', 'great', 'think', 'say', 'help', 'low', 'line', 'differ', 'turn', 'cause', 'much', 'mean', 'before', 'move', 'right', 'boy', 'old', 'too', 'same', 'she', 'all', 'there', 'when', 'up', 'use', 'word', 'how', 'said', 'an', 'each', 'which', 'she', 'do', 'how', 'their', 'if', 'will', 'up', 'other', 'about', 'out', 'many', 'then', 'them', 'these', 'so', 'some', 'her', 'would', 'make', 'like', 'into', 'him', 'has', 'two', 'more', 'go', 'no', 'way', 'could', 'my', 'than', 'first', 'been', 'call', 'who', 'its', 'now', 'find', 'long', 'down', 'day', 'did', 'get', 'come', 'made', 'may', 'part'].includes(word))
                    .slice(0, 3);
                
                keywords.push(...words);
                
                return [...new Set(keywords)].slice(0, 5);
            }

            detectEmptySpace(previewElement) {
                const emptySpaces = [];
                const pageHeight = previewElement.offsetHeight;
                const contentHeight = previewElement.scrollHeight;
                
                console.log('üñºÔ∏è Detect empty space - pageHeight:', pageHeight, 'contentHeight:', contentHeight, 'minEmptySpace:', this.minEmptySpace);
                
                if (contentHeight < pageHeight - this.minEmptySpace) {
                    console.log('üñºÔ∏è Found bottom empty space:', pageHeight - contentHeight);
                    emptySpaces.push({
                        type: 'bottom',
                        height: pageHeight - contentHeight,
                        position: 'bottom'
                    });
                }
                
                const contentBlocks = previewElement.querySelectorAll('h1, h2, h3, p, ul, ol');
                console.log('üñºÔ∏è Found content blocks:', contentBlocks.length);
                
                for (let i = 0; i < contentBlocks.length - 1; i++) {
                    const currentBlock = contentBlocks[i];
                    const nextBlock = contentBlocks[i + 1];
                    
                    const currentRect = currentBlock.getBoundingClientRect();
                    const nextRect = nextBlock.getBoundingClientRect();
                    const previewRect = previewElement.getBoundingClientRect();
                    
                    const gap = nextRect.top - (currentRect.bottom + previewRect.top);
                    
                    if (gap > this.minEmptySpace) {
                        console.log('üñºÔ∏è Found gap between blocks:', gap);
                        emptySpaces.push({
                            type: 'between',
                            height: gap,
                            position: 'after',
                            afterElement: currentBlock
                        });
                    }
                }
                
                console.log('üñºÔ∏è Total empty spaces found:', emptySpaces.length);
                return emptySpaces;
            }

            async placeImage(emptySpace, content, previewElement) {
                console.log('üñºÔ∏è placeImage called - currentImages:', this.currentImages.size, 'maxImagesPerPage:', this.maxImagesPerPage);
                
                if (this.currentImages.size >= this.maxImagesPerPage) {
                    console.log('üñºÔ∏è Max images reached, skipping');
                    return;
                }

                const keywords = this.extractKeywords(content);
                const searchQuery = keywords.join(' ') || 'professional business';
                console.log('üñºÔ∏è Searching for images with query:', searchQuery);
                
                try {
                    const images = await this.searchImages(searchQuery, 3);
                    console.log('üñºÔ∏è Found images:', images.length);
                    
                    if (images.length === 0) {
                        console.log('üñºÔ∏è No images found, returning');
                        return;
                    }

                    const selectedImage = images[Math.floor(Math.random() * images.length)];
                    const imageId = `auto-image-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                    console.log('üñºÔ∏è Selected image:', selectedImage.id, selectedImage.url);
                    
                    const imageElement = document.createElement('div');
                    imageElement.className = 'auto-placed-image';
                    imageElement.id = imageId;
                    imageElement.innerHTML = `
                        <img src="${selectedImage.url}" 
                             alt="${selectedImage.alt}" 
                             style="width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                    `;

                    if (emptySpace.type === 'bottom') {
                        console.log('üñºÔ∏è Placing image at bottom');
                        previewElement.appendChild(imageElement);
                    } else if (emptySpace.type === 'between' && emptySpace.afterElement) {
                        console.log('üñºÔ∏è Placing image after element:', emptySpace.afterElement);
                        emptySpace.afterElement.insertAdjacentElement('afterend', imageElement);
                    }

                    this.currentImages.add(imageId);
                    console.log('üñºÔ∏è Image placed successfully, current count:', this.currentImages.size);

                } catch (error) {
                    console.error('üñºÔ∏è Error placing image:', error);
                }
            }

            async processPreviewForImages(content, previewElement, options = {}) {
                const { demandOnly = false, ensureAtLeastOne = false, auto = false } = options;
                console.log('üñºÔ∏è Processing images - autoImageEnabled:', this.autoImageEnabled, 'options:', options);
                if (!this.autoImageEnabled && !demandOnly && !ensureAtLeastOne && !auto) return false;

                this.clearAutoImages(previewElement);
                await new Promise(resolve => setTimeout(resolve, 100));

                const emptySpaces = this.detectEmptySpace(previewElement);
                console.log('üñºÔ∏è Empty spaces detected:', emptySpaces.length);

                if (emptySpaces.length === 0) {
                    console.log('üñºÔ∏è No empty spaces found');
                    return false;
                }

                for (const emptySpace of emptySpaces) {
                    if (this.currentImages.size >= this.maxImagesPerPage) break;
                    await this.placeImage(emptySpace, content, previewElement);
                }

                return this.currentImages.size > 0;
            }

            clearAutoImages(previewElement) {
                const autoImages = previewElement.querySelectorAll('.auto-placed-image');
                autoImages.forEach(img => img.remove());
                this.currentImages.clear();
            }
        }

        const imageManager = new TestImageManager();

        function showStatus(message) {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div style="margin: 10px 0; padding: 10px; background: #e3f2fd; border-radius: 4px; color: #1976d2;">${message}</div>`;
        }

        async function testImagePlacement() {
            showStatus('Testing automatic image placement...');
            const content = document.getElementById('pdfPreview').textContent;
            const preview = document.getElementById('pdfPreview');
            
            const result = await imageManager.processPreviewForImages(content, preview, { auto: true });
            
            if (result) {
                showStatus(`Success! Added ${imageManager.currentImages.size} image(s) to fill empty space.`);
            } else {
                showStatus('No empty space found or images could not be added.');
            }
        }

        function clearImages() {
            const preview = document.getElementById('pdfPreview');
            imageManager.clearAutoImages(preview);
            showStatus('All images cleared.');
        }

        function addMoreContent() {
            const preview = document.getElementById('pdfPreview');
            const newContent = `
                <h2>Additional Section</h2>
                <p>This is additional content to test how the system handles more text. We want to see if images are placed appropriately between sections.</p>
                
                <h2>Conclusion</h2>
                <p>In conclusion, this strategy provides a solid foundation for future growth and success in our market segment.</p>
            `;
            preview.insertAdjacentHTML('beforeend', newContent);
            showStatus('Additional content added. Try testing image placement again.');
        }

        // Set CSS variables
        const preview = document.getElementById('pdfPreview');
        preview.style.setProperty('--title-color', '#1e40af');
        preview.style.setProperty('--header-color', '#3b82f6');
        preview.style.setProperty('--body-color', '#475569');
        preview.style.setProperty('--accent-color', '#3b82f6');
        preview.style.setProperty('--title-size', '32px');
        preview.style.setProperty('--header-size', '24px');
        preview.style.setProperty('--body-size', '14px');
        preview.style.setProperty('--margin-top', '1in');
        preview.style.setProperty('--margin-bottom', '1in');
        preview.style.setProperty('--margin-left', '1in');
        preview.style.setProperty('--margin-right', '1in');
        preview.style.setProperty('--page-width', '8.5in');
        preview.style.setProperty('--page-height', '11in');
    </script>
</body>
</html>
